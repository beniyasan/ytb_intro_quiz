# アーキテクチャ選定書

## 1. プロジェクト概要

YouTube APIを使用したリアルタイム早押しイントロクイズWebアプリケーションのアーキテクチャ選定書です。

## 2. システム要求分析

### 2.1 機能要件
- YouTube APIを使用したプレイリストの取得・再生
- リアルタイム早押し機能
- マルチユーザー対戦機能
- セッションベースのルーム管理
- スコア管理・ランキング機能

### 2.2 非機能要件
- **レスポンス性能**: 早押し判定は50ms以内
- **同時接続数**: 1ルームあたり最大20人、同時100ルーム対応
- **可用性**: 99.9%以上
- **拡張性**: 水平スケーリング可能な設計

## 3. アーキテクチャパターン選定

### 3.1 選定アーキテクチャ: **マイクロサービス + イベント駆動アーキテクチャ**

#### 選定理由
1. **リアルタイム性**: WebSocketによる双方向通信で低遅延を実現
2. **スケーラビリティ**: 各サービスの独立したスケーリングが可能
3. **保守性**: 機能ごとにサービスを分離し、独立した開発・デプロイが可能
4. **耐障害性**: 一部サービスの障害が全体に波及しない

### 3.2 システム構成

```
┌─────────────────────────────────────────────────────────┐
│                    クライアント層                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   ホスト画面   │  │  プレイヤー画面 │  │   観戦画面    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │   API Gateway      │
                    │   (nginx/Kong)     │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────┴─────────────────────────────┐
│                      バックエンド層                          │
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  認証サービス  │  │ セッション管理 │  │  クイズ管理   │  │
│  │    (Auth)     │  │   (Session)   │  │    (Quiz)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ WebSocket     │  │  YouTube API  │  │   スコア管理  │  │
│  │   Server      │  │   Proxy       │  │   (Score)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┴─────────────────────────────┐
│                    インフラ層                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Redis       │  │  PostgreSQL   │  │  Message Queue│  │
│  │  (Cache/Pub-Sub)│ │     (RDB)     │  │   (RabbitMQ)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────────────────────────────────────────────────┘
```

## 4. 技術スタック選定

### 4.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **状態管理**: Zustand
- **リアルタイム通信**: Socket.io-client
- **UI コンポーネント**: Tailwind CSS + shadcn/ui
- **動画再生**: YouTube IFrame Player API

### 4.2 バックエンド
- **言語**: Node.js (TypeScript)
- **フレームワーク**: NestJS
- **WebSocket**: Socket.io
- **API Gateway**: Kong または nginx
- **認証**: JWT + OAuth2.0

### 4.3 データベース・キャッシュ
- **RDB**: PostgreSQL
- **キャッシュ**: Redis
- **セッション管理**: Redis
- **メッセージキュー**: RabbitMQ

### 4.4 インフラ・デプロイ
- **コンテナ化**: Docker
- **オーケストレーション**: Kubernetes
- **CI/CD**: GitHub Actions
- **クラウド**: AWS (EKS, RDS, ElastiCache)
- **監視**: Prometheus + Grafana

## 5. キーアーキテクチャ決定事項

### 5.1 リアルタイム通信戦略
- WebSocketを使用した双方向通信
- Redis Pub/Subによるサーバー間通信
- 早押し判定はRedisのアトミック操作で実装

### 5.2 スケーリング戦略
- WebSocketサーバーの水平スケーリング
- Sticky Sessionによる接続管理
- マイクロサービスごとの独立したスケーリング

### 5.3 データ整合性
- イベントソーシング パターンの採用
- CQRSによる読み取りと書き込みの分離
- 最終的整合性モデル

### 5.4 セキュリティ
- JWT トークンによる認証
- Rate Limiting
- WebSocket接続の認証・認可
- YouTube API キーの安全な管理

## 6. リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| WebSocket接続の不安定性 | 高 | 再接続メカニズム、フォールバック実装 |
| YouTube API レート制限 | 中 | キャッシング戦略、プロキシサーバー実装 |
| 同時大量アクセス | 高 | オートスケーリング、負荷分散 |
| データ不整合 | 中 | トランザクション管理、イベントソーシング |

## 7. 移行戦略

### Phase 1: MVP開発（1-2ヶ月）
- 基本的なクイズ機能
- シングルルーム対応
- 基本的な早押し機能

### Phase 2: スケーラビリティ強化（2-3ヶ月）
- マルチルーム対応
- Redis クラスタリング
- 負荷分散実装

### Phase 3: 機能拡張（3-4ヶ月）
- ランキング機能
- トーナメントモード
- カスタムプレイリスト機能

## 8. まとめ

選定したマイクロサービス + イベント駆動アーキテクチャにより、以下を実現します：

1. **高いリアルタイム性**: WebSocketとRedisによる低遅延通信
2. **優れたスケーラビリティ**: 水平スケーリングによる負荷対応
3. **高い保守性**: サービス分離による独立した開発・運用
4. **堅牢性**: 障害の局所化と自動復旧メカニズム

このアーキテクチャにより、要件を満たす高品質なリアルタイムクイズアプリケーションの構築が可能です。